


# 🧠 Brain Age Prediction Pipeline

This repository provides a **Brain Age Prediction framework** using volumetric MRI features and deep learning models. It includes data preprocessing, feature selection (via RkCNN), and evaluation with age-stratified analysis.

---

## 📂 Repository Structure

```

BrainAge-prediction/
│
├── Data/                             # Input data (Excel & CSV files)
│   ├── QC\_removed\_raw\_sheet.xlsx                # Raw volumetric features
│   ├── QC\_removed\_raw\_sheet\_valid\_features.xlsx # Cleaned valid features (age, sex, volumes)
│   └── selected\_features.csv                    # Final features (selected via RkCNN)
│
├── RkCNN.py              # Implements RkCNN feature selection (based on PeerJ-CS paper)
├── Pipeline.py           # Combined Brain Age prediction pipeline
├── Trial.py              # Combined Brain Age prediction pipeline and runs for 5 different trials
├── Check\_less\_40.py      # Brain Age prediction for participants < 40
├── Check\_more\_40.py      # Brain Age prediction for participants ≥ 40
├── RkCNN.py              # Feature selection (RkCNN algorithm)
├── avg\_results.ipynb     # Aggregates results across multiple runs
├── README.md             # This guide
│
├── Results/ (example output files)
│   ├── \*\_results\_before.csv / \*\_results\_after.csv
│   ├── \*\_performance\_metrics\_before.png / \*\_performance\_metrics\_after.png
│   ├── \*\_scatter\_plots\_before.png / \*\_scatter\_plots\_after.png
│   ├── \*\_feature\_importance\_before.png / \*\_feature\_importance\_after.png
│   ├── \*\_bias\_correction\_improvements\_before.png / \*\_bias\_correction\_improvements\_after.png
│   └── \*\_best\_models\_comparison.csv / \*.png

````

---

## 📊 Data Files

- **QC_removed_raw_sheet.xlsx**  
  Raw volumetric MRI feature set.  

- **QC_removed_raw_sheet_valid_features.xlsx**  
  Filtered dataset containing only valid predictors (age, sex, regional brain volumes).  

- **selected_features.csv**  
  Final feature set generated by `RkCNN.py`. Implements the Recursive k-Nearest Neighbors Feature Selection algorithm from:  
  [PeerJ Computer Science, DOI: 10.7717/peerj-cs.2497](http://dx.doi.org/10.7717/peerj-cs.2497).

---

## 🚀 Usage

### 1. Feature Selection (RkCNN)

```bash
python RkCNN.py
````

This processes the valid features file and generates `selected_features.csv`.

---

### 2. Age-Stratified Prediction

#### For participants < 40:

```bash
python Check_less_40.py --data Data/QC_removed_raw_sheet_valid_features.xlsx
```

#### For participants ≥ 40:

```bash
python Check_more_40.py --data Data/QC_removed_raw_sheet_valid_features.xlsx
```

Both scripts:

* Train/test CNNs.
* Save results and plots in CSV/PNG format.

---

### 3. Combined Pipeline

Runs both **<40** and **≥40** branches in a unified workflow:

```bash
python Pipeline.py --data Data/selected_features.csv
```

Arguments:

* `--data` : Path to `selected_features.csv`.

---

### 4. Trials

Chooses the best model among 5 different trials

```bash
python Trial.py --data Data/selected_features.csv --output_dir Trial_results
```
### 5. Inference

Gives the brain_age_predictions.csv using the Trial_results

```bash
python Inference.py --models_dir Trial_results/saved_models --volumes Post_contrast_segmented_output.csv --metadata metadata.json 
```

### 6. 🚀 **NEW: FastAPI Web Service**

A comprehensive REST API for brain age prediction with multiple endpoints:

```bash
# Start the API server
python api.py
# or use the startup script
./start_api.ps1
```

**API Features:**
- **Single Subject Prediction**: Predict brain age for individual subjects
- **Batch Processing**: Handle multiple subjects at once
- **CSV Upload**: Process CSV files with metadata
- **Model Information**: Get model details and performance metrics
- **Template Downloads**: Get CSV and metadata templates
- **Interactive Documentation**: Automatic API docs at `/docs`

**API Endpoints:**
- `GET /health` - Health check and model status
- `GET /models/info` - Model information and performance
- `POST /predict/single` - Single subject prediction
- `POST /predict/batch` - Batch prediction
- `POST /predict/csv` - CSV file upload prediction
- `GET /predict/template/csv` - Download CSV template
- `GET /predict/template/metadata` - Download metadata template
- `GET /features/required` - List required features

**Quick Start:**
```python
import requests

# Example prediction
response = requests.post("http://localhost:8000/predict/single", json={
    "subject_id": "MRB_001",
    "age": 25.0,
    "sex": "M",
    "volumes": { ... }  # 21 brain volume features
})
result = response.json()
print(f"Predicted brain age: {result['predicted_brain_age']}")
```

**Documentation:** See `API_README.md` for complete API documentation.

---

## 📈 Outputs

Each run produces:

* **Results CSVs** (`*_results_before.csv`, `*_results_after.csv`)
  Predicted vs true ages.

* **Performance Plots**

  * Scatter plots (before/after correction).
  * Bias correction improvements.
  * Error distributions.
  * Feature importance maps.
  * Correlation heatmaps.

* **Best Model Comparisons**
  CSV/PNG summaries of top-performing models.

---

## ⚙️ Example Output Naming Convention

* `43_results_before.csv` → Results for experiment 43 (pre-correction).
* `43_results_after.csv` → Results for experiment 43 (post-correction).
* `43_performance_metrics_before.png` → Metrics visualization (before).
* `43_performance_metrics_after.png` → Metrics visualization (after).
* `43_best_models_comparison.csv` → Best models summary.

Other experiment IDs (e.g., `67`, `100`, `333`, `666`, `876`) follow the same format.

---

## 📖 Notes

* All plots/results are stored in the same directory as the scripts by default.
* Feature selection via RkCNN is **required** before running the main pipeline.
* Age-stratified analysis ensures better bias handling in predictions.

---

## 📌 Citation

If you use this pipeline, please cite:

> Li, J. et al. (2019). *Recursive k-nearest neighbors feature selection for high-dimensional data*. PeerJ Computer Science, 5\:e2497. DOI: [10.7717/peerj-cs.2497](http://dx.doi.org/10.7717/peerj-cs.2497)
